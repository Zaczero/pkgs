name: Release Package

on:
  workflow_call:
    inputs:
      package:
        required: true
        type: string
      version:
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      type: ${{ steps.check.outputs.type }}
    steps:
      - uses: actions/checkout@v4

      - id: check
        name: Validate version and detect type
        run: |
          pkg="${{ inputs.package }}"

          if [ -f "$pkg/Cargo.toml" ]; then
            echo "type=python-rust" >> $GITHUB_OUTPUT
            version=$(grep '^version' "$pkg/Cargo.toml" | head -1 | cut -d'"' -f2)
            if [ "$version" != "${{ inputs.version }}" ]; then
              echo "Tag version (${{ inputs.version }}) != Cargo.toml ($version)"
              exit 1
            fi
          else
            echo "type=python" >> $GITHUB_OUTPUT
            pkg_name=$(echo "$pkg" | tr '-' '_')
            version=$(grep -oP "__version__\s*=\s*['\"]?\K[^'\"]*" "$pkg/$pkg_name/__init__.py")
            if [ "$version" != "${{ inputs.version }}" ]; then
              echo "Tag version (${{ inputs.version }}) != __init__.py ($version)"
              exit 1
            fi
          fi

  release-python-rust:
    needs: validate
    if: needs.validate.outputs.type == 'python-rust'
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/${{ inputs.package }}
    permissions:
      id-token: write
      attestations: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: dist-${{ inputs.package }}-*
          path: dist
          merge-multiple: true

      - uses: actions/attest-build-provenance@v2
        with:
          subject-path: dist/*

      - uses: pypa/gh-action-pypi-publish@release/v1

  release-python:
    needs: validate
    if: needs.validate.outputs.type == 'python'
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/${{ inputs.package }}
    permissions:
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5

      - name: Build
        run: uv build -o dist ${{ inputs.package }}

      - uses: actions/attest-build-provenance@v2
        with:
          subject-path: dist/*

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
